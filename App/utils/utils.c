#include "beep.h"
#include "headfile.h"
#include "led.h"

static SoundLight_t sound_light = {
	.flag = 0, // 声光提示激活标志：1 表示正在进行声光报警，如避障蜂鸣器提醒；0 表示无报警
	.time = 0  // 声光提示计时器：记录声光报警的持续时间，到达设定值后自动关闭蜂鸣器等提示
};

/**
 * @brief 系统初始化函数，初始化所有模块和外设
 * @param 无
 * @retval 无
 */
void System_Init(void)
{
    LedDeviceInit();
    BeepDeviceInit();
    KeyDeviceInit();
    MPU_Init();
    Motor_Init();
    Encoder_Init();
    OLED_Init();
    HCSR04_Init();
    HC06_Init();
    PID_Init(&dist, POSITION_PID, dist_pid.kp, dist_pid.ki, dist_pid.kd);
    delay_ms(10);
}

/**
 * @brief 声光提示启动函数（例如避障触发后报警）
 * @param 无
 * @retval 无
 */
void SoundLight(void)
{
	if(sound_light.flag == 0)
	{
        SetLedMode(LED_FOLLOW, LED_ON);
		SetBeepMode(BEEP_SYSTEM, BEEP_ON);
		sound_light.flag = 1;
	}
}

/**
 * @brief 声光提示状态更新函数，计时并关闭报警
 * @param 无
 * @retval 无
 */
void UpdateSoundLight(void)
{
    if(sound_light.flag)
    {
        sound_light.time++;

		if(sound_light.time >= 20) 
		{
            SetLedMode(LED_FOLLOW, LED_OFF);
	    	SetBeepMode(BEEP_SYSTEM, BEEP_OFF);
			sound_light.time = 0;
			sound_light.flag = 0; 
		}
        
    }
}

